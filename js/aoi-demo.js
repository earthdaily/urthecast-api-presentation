// This example creates an Area of Interest
document.querySelector('#create-sf-aoi').addEventListener('click', function(evt) {
    evt.preventDefault();
    var data = $('#sf-aoi').html();

    // createAOI callback will receive data and URL and print to screen
    createAOI(data, function(data, url) {
        var name = data.payload[0]['name'],
            id = data.payload[0]['id'];

        // Set the ID and name in localStorage for easy use in later demos
        localStorage.setItem('sf-aoi-id', id);
        localStorage.setItem('sf-aoi-name', name);

        // Create the AOI map
        var aoiMap = L.map('aoi-map', {
            keyboard: false,
            attributionControl: false
        }).setView([38.7386, -121.7299], 8);

        // Set a Mapbox basemap layer so we have some context on where we are in the world
        var layer = L.tileLayer('http://api.mapbox.com/v4/urthecast2.ipog0aj7/{z}/{x}/{y}.jpg?access_token=pk.eyJ1IjoidXJ0aGVjYXN0MiIsImEiOiJKM1pwMnFZIn0.ReeiMLJtH18oqVeto7KyZw').addTo(aoiMap);

        var geoJson = L.geoJson(data.payload[0].geometry).addTo(aoiMap);

        aoiMap.fitBounds(geoJson);


        document.querySelector("#create-sf-aoi-response-name").textContent = name;
        document.querySelector("#create-sf-aoi-response-id").textContent = id;
        document.querySelector("#create-sf-aoi-response-url").textContent = url + "\n\n" + JSON.stringify(data);
    });
});

// This examples queries the Archive/Catalog, restricting by AOI ID
document.querySelector('#catalog-filter-aoi').addEventListener('click', function(evt) {
    evt.preventDefault();

    // Expects AOi to have been created
    var aoiId = localStorage.getItem('sf-aoi-id');

    // Query the catalog, including the geometry parameter w/ intersects filter
    // This will ensure all scenes returned intersect with the AOI ID provided
    queryCatalog(['geometry_intersects=' + aoiId], function(data, url) {
        document.querySelector("#catalog-filter-aoi-response").textContent = data.meta.total;
        document.querySelector("#catalog-filter-aoi-url").textContent = url + "\n\n" + JSON.stringify(data.meta);
    });
});

// Get the next Forecast (capture opportunity) for the Theia sensor for our AOI
document.querySelector('#sat-tracker-forecast-aoi').addEventListener('click', function(evt) {
    evt.preventDefault();

    // Expects AOI to have been created - no error handling
    var aoiID = localStorage.getItem('sf-aoi-id');

    // method is in sat-tracker-demo.js
    getNextForecastForAOI(aoiID, 'theia', function(data, url) {
        var next = data.payload[0]['first_orbit_point_epoch'];

        document.querySelector("#sat-tracker-forecast-aoi-response").textContent = moment(next).fromNow();
        document.querySelector("#sat-tracker-forecast-aoi-url").textContent = url;
    });
});

// Get the next Forecast (capture opportunity) for the oli-tirs sensor (Landsat 8) for our AOI ID
document.querySelector('#sat-tracker-forecast-aoi-landsat').addEventListener('click', function(evt) {
    evt.preventDefault();

    // Expects AOi to have been created - no error handling
    var aoiID = localStorage.getItem('sf-aoi-id');

    // method is in sat-tracker-demo.js
    getNextForecastForAOI(aoiID, 'oli-tirs', function(data, url) {
        var next = data.payload[0]['first_orbit_point_epoch'];
        document.querySelector("#sat-tracker-forecast-aoi-response-landsat").textContent = moment(next).fromNow();
        document.querySelector("#sat-tracker-forecast-aoi-url-landsat").textContent = url + "\n\n" + JSON.stringify(data);
    });
});

// Helper method that actually makes the API request to create an AOI
function createAOI(data, callback) {
    var apiKey = localStorage.getItem('apiKey');
        apiSecret = localStorage.getItem('apiSecret'),
        url = "https://api.urthecast.com/v1/consumers/apps/me/aois?api_key=" + apiKey + "&api_secret=" + apiSecret + "&";

    $.ajax({
        type: "POST",
        url: url,
        contentType: 'application/json',
        data: data,
        success: function (data) {
            console.log(data);
            if (callback) callback(data, url);
        }
    });
}
